<input id="coupangLink" placeholder="쿠팡 원본/짧은 링크" autocomplete="off" />
<button id="generateBtn">생성</button>
<textarea id="result" rows="8" style="width:100%"></textarea>

<script>
// URL 필터: 영문/숫자/:/?/&/= . _ - 만 허용
const filterUrl = s => (s || '').replace(/[^a-zA-Z0-9:\/?&=._-]/g, '');

document.getElementById('coupangLink').addEventListener('input', (e) => {
  e.target.value = filterUrl(e.target.value);
});

document.getElementById('generateBtn').addEventListener('click', async () => {
  const urlRaw = document.getElementById('coupangLink').value.trim();
  const url = filterUrl(urlRaw);
  if (!url) return alert('쿠팡 상품 링크를 입력하세요.');

  try {
    // ❗ 브라우저에서 쿠팡 페이지 직접 fetch 하지 말고, Netlify 함수로 요청
    const resp = await fetch('/.netlify/functions/create-deeplink', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ url })
    });
    const data = await resp.json();
    if (!resp.ok || !data.success) {
      throw new Error(data?.error?.message || data?.reason || `HTTP ${resp.status}`);
    }

    const name = data.info?.name || '상품명 없음';
    const priceNum = data.info?.price; // 숫자(원)
    const priceText = Number.isFinite(priceNum) ? priceNum.toLocaleString('ko-KR') + '원' : '가격 정보 없음';
    const deeplink = data.deeplink || data.link || url;

    const template = `【쿠팡】${name}
가격: ${priceText}
링크: ${deeplink}

※ 모든 핫딜은 카드 할인 및 쿠폰 적용가 기준입니다.
※ 이 포스팅은 쿠팡파트너스 활동의 일환으로, 이에 따른 일정액의 수수료를 제공받습니다. 구입 시 제품 가격에는 아무런 영향이 없습니다.`;

    document.getElementById('result').value = template;
  } catch (err) {
    console.error(err);
    alert('상품 정보를 가져오는 데 실패했습니다.\n' + err.message);
  }
});
</script>
