<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>쿠팡 딥링크 · 자동 채움</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-neutral-50">
  <div class="min-h-screen flex flex-col gap-4 items-center p-6">
    <h1 class="text-2xl font-bold">쿠팡 딥링크 · 자동 채움</h1>

    <div class="w-full max-w-xl bg-white shadow rounded-2xl p-4">
      <label class="text-sm text-gray-600">문장(첫 번째 http(s)만 인식)</label>
      <input id="inp" class="mt-2 w-full border rounded-xl p-3" placeholder="예) 쿠팡을 추천합니다! https://link.coupang.com/a/XXXXX" autocomplete="off" autocapitalize="off">
      <div class="mt-3 flex gap-2">
        <button id="go" class="px-4 py-2 rounded-xl bg-black text-white">딥링크 생성</button>
      </div>

      <div id="err" class="mt-3 text-sm text-red-600 hidden"></div>

      <div class="mt-4">
        <div class="text-sm text-gray-500">파트너스 링크</div>
        <div id="deeplink" class="mt-1 text-sm break-all border rounded-xl p-3 bg-neutral-50 text-gray-500">(아직 없음)</div>
      </div>

      <div class="mt-3 grid grid-cols-1 sm:grid-cols-3 gap-3">
        <div>
          <div class="text-sm text-gray-500">상품명 (자동)</div>
          <div id="pname" class="mt-1 border rounded-xl p-3 bg-neutral-50 text-gray-400">딥링크 생성 후 자동 채움</div>
        </div>
        <div>
          <div class="text-sm text-gray-500">가격(원, 자동)</div>
          <div id="pprice" class="mt-1 border rounded-xl p-3 bg-neutral-50 text-gray-400">딥링크 생성 후 자동 채움</div>
        </div>
        <div>
          <div class="text-sm text-gray-500">수량</div>
          <input id="qty" value="1" class="mt-1 border rounded-xl p-3 bg-white" type="number" min="1">
        </div>
      </div>

      <!-- 템플릿 미리보기 + 복사 -->
      <div class="mt-4">
        <div class="flex items-center justify-between">
          <div class="text-sm text-gray-500">템플릿 미리보기</div>
          <button id="copyTpl" class="px-3 py-2 rounded-lg border text-xs sm:text-sm">전체 복사</button>
        </div>
        <pre id="tpl" class="mt-2 bg-neutral-50 border rounded-xl p-3 text-sm whitespace-pre-wrap leading-7"></pre>
      </div>

      <details class="mt-4">
        <summary class="text-sm text-gray-500 cursor-pointer">API 응답(raw JSON)</summary>
        <pre id="raw" class="mt-2 bg-neutral-50 border rounded-xl p-3 text-xs break-all">(없음)</pre>
      </details>
    </div>
  </div>

<script>
const ENDPOINT_DEEP = "/.netlify/functions/create-deeplink";
const ENDPOINT_INFO = "/.netlify/functions/product-info";

const $ = (id) => document.getElementById(id);
const $inp = $("inp"), $go = $("go"), $qty = $("qty"), $copy = $("copyTpl");
const $err = $("err"), $raw = $("raw"), $tpl = $("tpl");
const $deeplink = $("deeplink"), $pname = $("pname"), $pprice = $("pprice");

let pname = "", pprice = 0, deeplink = "";

const extractFirstUrl = (s) => {
  const m = String(s||"").match(/https?:\/\/[^\s]+/);
  return m ? m[0] : "";
};

function updateTemplate() {
  const qty = Number($qty.value) || 1;
  const totalPrice = pprice * qty;
  const formatted = (n) => n.toLocaleString("ko-KR");
  $tpl.textContent =
`【쿠팡】${pname || "상품명"}
가격: ${pprice ? formatted(pprice) + "원" : "가격정보"}
수량: ${qty}
합계: ${totalPrice ? formatted(totalPrice) + "원" : "-"}
링크: ${deeplink || "쿠팡링크"}

※ 모든 핫딜은 카드 할인 및 쿠폰 적용가 기준입니다.
※ 이 포스팅은 쿠팡파트너스 활동의 일환으로, 이에 따른 일정액의 수수료를 제공받습니다. 구입 시 제품 가격에는 아무런 영향이 없습니다.`;
}

$qty.addEventListener("input", updateTemplate);

$go.addEventListener("click", async () => {
  $err.classList.add("hidden");
  $deeplink.textContent = "(생성 중...)
