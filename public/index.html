<!-- ...상단은 기존 그대로... -->
<script>
  const SITE_ORIGIN = ""; // 같은 도메인이면 "" 유지
  const ENDPOINT_DEEP = SITE_ORIGIN + "/.netlify/functions/create-deeplink";
  const ENDPOINT_INFO = SITE_ORIGIN + "/.netlify/functions/product-info";

  const $ = id => document.getElementById(id);
  const $inp = $("inp"), $err = $("err"), $raw = $("raw");
  const $deeplink = $("deeplink"), $pname = $("pname"), $pprice = $("pprice"), $tpl = $("tpl");
  const $btnCopyLink = $("btnCopyLink"), $btnGo = $("btnGo"), $btnInfo = $("btnInfo");

  const firstUrl = s => (String(s||"").match(/https?:\/\/[^\s]+/)||[])[0] || "";
  const fmt = n => Number(n||0).toLocaleString("ko-KR")+"원";
  const setErr = msg => { if(!msg){$err.style.display="none";$err.textContent="";return;} $err.style.display="block"; $err.textContent=msg; };
  const setTpl = ()=>{
    const name = $pname.textContent && $pname.textContent !== "-" ? $pname.textContent : "상품명";
    const priceTxt = $pprice.textContent && $pprice.textContent !== "-" ? $pprice.textContent : "가격정보";
    const link = $deeplink.textContent && !$deeplink.textContent.startsWith("(") ? $deeplink.textContent : "쿠팡링크";
    $tpl.textContent = `【쿠팡】${name}
가격: ${priceTxt}
링크: ${link}

※ 모든 핫딜은 카드 할인 및 쿠폰 적용가 기준입니다.
※ 이 포스팅은 쿠팡파트너스 활동의 일환으로, 이에 따른 일정액의 수수료를 제공받습니다. 구입 시 제품 가격에는 아무런 영향이 없습니다.`;
  };
  const postJSON = async (url, body)=>{
    const res = await fetch(url,{ method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body) });
    const text = await res.text(); let json; try{ json=JSON.parse(text);}catch{ json={ parseError:true, raw:text }; }
    return { ok:res.ok, status:res.status, json, text };
  };
  const updateCopyLinkButton = ()=> {
    const link = $deeplink.textContent?.trim();
    const valid = link && !link.startsWith("(");
    $btnCopyLink.disabled = !valid;
  };

  // URL 정규화(프런트 보조)
  const normalize = u => {
    const m = String(u||"").match(/\/products\/(\d{6,})/);
    return m ? `https://www.coupang.com/vp/products/${m[1]}` : u;
  };

  // 클릭 연타 방지
  let _busy = false;
  const withBusy = async (fn) => {
    if (_busy) return;
    _busy = true; $btnGo.disabled = true; $btnInfo.disabled = true;
    try { await fn(); } finally { _busy = false; $btnGo.disabled = false; $btnInfo.disabled = false; }
  };

  // 딥링크 생성
  $btnGo.onclick = () => withBusy(async () => {
    setErr(""); $raw.textContent="(요청 중...)";
    $deeplink.textContent="(생성 중...)"; $pname.textContent="-"; $pprice.textContent="-"; updateCopyLinkButton(); setTpl();

    const url0 = firstUrl($inp.value);
    if(!url0){ setErr("쿠팡 링크를 입력하세요."); $deeplink.textContent="(아직 없음)"; updateCopyLinkButton(); return; }
    const url = normalize(url0);

    try{
      const deep = await postJSON(ENDPOINT_DEEP, { url });
      $raw.textContent = deep.text;
      if (!deep.json || deep.json.success === false) throw new Error(deep.json?.error?.message || deep.json?.reason || ("HTTP "+deep.status));
      const link = deep.json.deeplink || deep.json.link || "";
      $deeplink.textContent = link || "(생성 실패)";
      updateCopyLinkButton();

      await fillProductInfo(url); // 생성 직후 자동 채움
    }catch(e){ setErr(e?.message || String(e)); }
    finally{ setTpl(); }
  });

  // 상품정보 채우기(수동)
  $btnInfo.onclick = () => withBusy(async () => {
    const url0 = firstUrl($inp.value);
    if(!url0){ setErr("쿠팡 링크를 입력하세요."); return; }
    await fillProductInfo(normalize(url0), true);
  });

  // 템플릿 복사
  $("btnCopy").onclick = async () => {
    await navigator.clipboard.writeText($tpl.textContent || "");
    alert("복사되었습니다.");
  };
  // 링크 복사
  $btnCopyLink.onclick = async () => {
    const link = $deeplink.textContent?.trim();
    if (!link || link.startsWith("(")) return;
    await navigator.clipboard.writeText(link);
    const prev = $btnCopyLink.textContent; $btnCopyLink.textContent = "복사됨!"; setTimeout(()=>{ $btnCopyLink.textContent = prev; }, 1200);
  };

  // 백엔드 결과로 화면 채우기
  async function fillProductInfo(url, appendRaw){
    try{
      const r = await fetch(ENDPOINT_INFO, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ url }) });
      const txt = await r.text(); let j; try{ j=JSON.parse(txt);}catch{ j=null; }
      if (appendRaw) $raw.textContent += "\n\n--- product-info ---\n" + (txt || "(empty)");
      if (!j?.success) throw new Error(j?.error || "product-info 실패");

      const title = j.title ?? "";
      const price = Number.isFinite(j.price) ? fmt(j.price) : "-"; // ← 정수 price를 원화로 표시
      if (title) $pname.textContent = title;
      if (price) $pprice.textContent = price;
      setTpl();
    }catch(e){
      const msg = String(e?.message || e);
      if (msg.includes("429") || msg.includes("concurrency")) setErr("요청이 많습니다. 잠시 후 다시 시도해주세요.");
      else setErr(msg);
    }
  }

  // 콘솔/북마클릿에서 바로 채우기용 공개 함수
  window.fillFromApi = async (input) => {
    const url = normalize((String(input||"").match(/https?:\/\/[^\s]+/)||[])[0] || input);
    $inp.value = url;
    await fillProductInfo(url, true);
  };

  setTpl(); updateCopyLinkButton();
</script>
